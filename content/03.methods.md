## Materials and Methods

### Biospecimen collection

The Pediatric Brain Tumor Atlas specimens are comprised of samples from Children's Brain Tumor Network (CBTN) and the Pediatric Pacific Neuro-oncology Consortium (PNOC).

#### Children's Brain Tumor Tissue Consortium (CBTN)

The CBTN [@url:https://CBTN.org] is a collaborative, multi-institutional (18 institutions worldwide) research program dedicated to the study of childhood brain tumors.
All CBTN data can be download from the Gabriella Miller Kids First Data Resource Center, [@url:https://kidsfirstdrc.org].
The de-identified patient's blood and tumor tissue were prospectively collected by the consortium from patients enrolled within the CBTN.

The cell lines were generated by the CBTN from either fresh tumor tissue obtained directly from surgery performed at Children’s Hospital of Philadelphia (CHOP) or from prospectively collected tumor specimens stored in Recover Cell Culture Freezing media (cat# 12648010, Gibco).
The tissue was dissociated using enzymatic method with papain as described [@doi:10.1101/656587].
Briefly, tissue was washed with HBSS (cat# 14175095, Gibco), minced and incubated with activated papain solution (cat# LS003124, SciQuest) for up to 45 minutes.
The papain was inactivated using ovomucoid solution (cat# 542000, SciQuest), tissue was briefly treated with DNase (cat#  10104159001, Sigma) and passed through the 100μm cell strainer (cat# 542000, Greiner Bio-One).
Two cell culture conditions were initiated based on the number of cells available.
For cultures utilizing the fetal bovine serum (FBS), a minimum density of 3×10^5 cells/ml were plated in DMEM/F-12 medium (cat# D8062, Sigma) supplemented with 20% FBS (cat# SH30910.03, Hyclone), 1% GlutaMAX (cat# 35050061, Gibco), Penicillin/Streptomycin-Amphotericin B Mixture (cat# 17-745E, Lonza) and 0.2% Normocin (cat# ant-nr-2, Invivogen).
For the serum-free media conditions cells were plated at minimum density of 1×10^6 cells/ml in DMEM/F12 media supplemented with 1% GlutaMAX, 1x B-27 supplement minus vitamin A (cat# 12587-010, Gibco), 1x N-2 supplement (cat# 17502001, Gibco), 20 ng/ml epidermal growth factor (cat# PHG0311L, Gibco), 20 ng/ml basic fibroblast growth factor (cat# 100-18B, PeproTech), 2.5μg/ml heparin (cat# H3149, Sigma), Penicillin/Streptomycin-Amphotericin B Mixture and 0.2% Normocin.

#### Pacific Pediatric Neuro-oncology Consortium (PNOC)

The Pacific Pediatric Neuro-Oncology Consortium (PNOC) [@url:https://www.pnoc.us/] is an international consortium dedicated to bringing new therapies to children and young adults with brain tumors.
PNOC collected blood and tumor biospecimens from newly-diagnosed diffuse intrinsic pontine glioma (DIPG) patients as part of the clinical trial [PNOC003/NCT02274987](https://clinicaltrials.gov/ct2/show/NCT02274987) [@doi:10.1002/ijc.32258].

### Nucleic acids extraction and library preparation

#### PNOC samples

The Translational Genomic Research Institute (TGEN; Phoenix, AZ) performed DNA and RNA extractions on tumor biopsies using a DNA/RNA AllPrep Kit (Qiagen, #80204).
All RNA used for library prep had a minimum RIN of 7 but no QC thresholds were implemented for the DNA.
For library preparation, 500ng of nucleic acids were used as input for RNA-Seq, WXS, and targeted DNA panel (panel).
The RNA prep was performed using the TruSeq RNA Sample Prep Kit (Illumina, #FC-122-1001) and the exome prep was performed using KAPA Library Preparation Kit (Kapa Biosystems, #KK8201) using Agilent's SureSelect Human All Exon V5 backbone with custom probes.
The targeted DNA panel developed by Ashion (formerly known as the GEM Cancer panel) consisted of exonic probes against 541 cancer genes.
Both panel and WXS assays contained 44,000 probes across evenly spaced genomic loci used for genome-wide copy number analysis.
For the panel, additional probes tiled across intronic regions of 22 known tumor suppressor genes and 22 genes involved in common cancer translocations for structural analysis.
All extractions and library preparations were performed according to manufacturer's instructions.

#### CBTN samples

Blood, tissue, and cell line DNA/RNA extractions were performed at the Biorepository Core at CHOP.
Briefly, 10-20 mg frozen tissue, 0.4-1ml of blood or 2×10^6 cells pellet was used for extractions.
Tissues were lysed using a Qiagen TissueLyser II (Qiagen) with 2×30 sec at 18Hz settings using 5 mm steel beads (cat# 69989, Qiagen).
Both tissue and cell pellets processes included a CHCl3 extraction and were run on the QIACube automated platform (Qiagen) using the AllPrep DNA/RNA/miRNA Universal kit (cat# 80224, Qiagen).
Blood was thawed and treated with RNase A (cat#, 19101, Qiagen); 0.4-1ml was processed using the Qiagen QIAsymphony automated platform (Qiagen) using the QIAsymphony DSP DNA Midi Kit (cat# 937255, Qiagen).
DNA and RNA quantity and quality was assessed by PerkinElmer DropletQuant UV-VIS spectrophotometer (PerkinElmer) and an Agilent 4200 TapeStation (Agilent, USA) for RINe and DINe (RNA Integrity Number equivalent and DNA Integrity Number equivalent respectively).
Library preparation and sequencing was performed by the NantHealth sequencing center.
Briefly, DNA sequencing libraries were prepared for tumor and matched-normal DNA using the KAPA HyperPrep kit (cat# KK8541, Roche); tumor RNA-Seq libraries were prepared using KAPA Stranded RNA-Seq with RiboErase kit (cat# KK8484, Roche).
Whole genome sequencing (WGS) was performed at an average depth of coverage of 60X for tumor samples and 30X for germline.
The panel tumor sample was sequenced to 470X and the normal panel sample was sequenced to 308X.
RNA samples were sequenced to an average of 200M reads.
All samples were sequenced on the Illumina HiSeq platform (X/400) (Illumina) with 2 × 150bp read length.

#### Data generation

NantHealth Sequencing Center (Culver City, CA) performed whole genome sequencing (WGS) on all paired tumor (~60X) and constitutive (~30X) DNA samples.
WGS libraries were 2x150 bp and sequenced on an Illumina X/400.
NantHealth Sequencing Center performed ribosomal-depleted whole transcriptome stranded RNA-Seq to an average depth of 100M reads for CBTN tumor samples.
The Translational Genomic Research Institute (TGEN; Phoenix, AZ) performed paired tumor (~200X) and constitutive whole exome sequencing (WXS) or targeted DNA panel (panel) and poly-A selected RNA-Seq (~200M reads) for  PNOC tumor samples.
PNOC WXS and RNA-Seq libraries 2x100 bp and sequenced on an Illumina HiSeq 2500.

### DNA WGS Alignment

We used BWA-MEM [@arxiv:1303.3997] v0.7.17 for alignment of paired-end DNA-seq reads.
We used version 38, patch release 12 of the _Homo sapiens_ genome as our alignment reference, which we obtained as a FASTA file from UCSC [@url:http://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/].
Alignments were further processed using following the Broad Institute's Best Practices [@url:https://software.broadinstitute.org/gatk/best-practices/workflow?id=11165] for processing Binary Alignment/Map files (BAMs) in preparation for variant discovery.
Duplicates were marked using SAMBLASTER [@doi:10/f6kft3] v0.1.24, BAMs merged and sorted using Sambamba [@doi:10/gfzsfw] v0.6.3.
Resultant BAMs were processing using Broad's Genome Analysis Tool Kit [GATK] (https://software.broadinstitute.org/gatk/) v4.0.3.0, BaseRecalibrator submodule.
Lastly, for normal/germline input, we run the GATK HaplotypeCaller [@doi:10.1101/201178] submodule on the recalibrated BAM, generating a genomic variant call format (GVCF) file.
This file is used as the basis for germline calling, described in the "SNV calling for B-allele Frequency (BAF) generation" section.
References can be obtained from the [Broad Genome References on AWS](https://s3.console.aws.amazon.com/s3/buckets/broad-references/hg38/v0/) bucket, with a general description of references here [@url:https://s3.amazonaws.com/broad-references/broad-references-readme.html].

### Quality Control of Sequencing Data

NGSCheckmate [@doi:10.1093/nar/gkx193] was performed on matched tumor/normal CRAM files to confirm sample matches and remove mismatched samples from the dataset.
CRAM inputs were preprocessed using BCFtools to filter and call 20k common single nucleotide polymorphisms (SNPs) using default parameters[@url:https://github.com/parklab/NGSCheckMate] and the resulting VCFs were used to run NGSCheckmate using [this workflow](https://github.com/d3b-center/ngs_checkmate_wf) in the D3b GitHub repository.
Per author guidelines, <= 0.61 was used as a correlation coefficient cutoff at sequencing depths >10 to predict mismatched samples.
For RNA-Seq, read strandedness was determined by running the [`infer_experiment.py` script](http://rseqc.sourceforge.net/#infer-experiment-py) on the first 200k mapped reads.
If calculated strandedness did not match strandedness information received from the sequencing center, samples were removed from analysis.
We required at least 60% of RNA-Seq reads mapped to the human reference or samples were removed from analysis.
MEND QC [@doi:10.1101/716829] was performed on aligned RNA-Seq reads using [this workflow](https://github.com/d3b-center/publication_workflows/blob/master/openPBTA/kfdrc-mendqc-wf.cwl) to identify mapped exonic non-duplicate reads.

### Germline Variant Calling

#### SNP calling for B-allele Frequency (BAF) generation

Germline haplotype calls were performed following the [GATK Joint Genotyping Workflow](https://software.broadinstitute.org/gatk/best-practices/workflow?id=11145), except the workflow was run on an individual sample basis.
This workflow was applied to the GVCF output from the alignment workflow on normal/germline samples.
Using only SNPs, we applied the [GATK generic hard filter suggestions](https://gatkforums.broadinstitute.org/gatk/discussion/2806/howto-apply-hard-filters-to-a-call-set) to the VCF, with an additional requirement of 10 reads minimum depth per SNP.
This filtered VCF was used as input to Control-FREEC and CNVkit (below) for generation of BAF files.
GATK v4.0.12.0 was used for all steps except `VariantFiltration`, which used 3.8.0 because as of GATK 4.0.12.0, this tool was beta and known to be unreliable for this purpose.
This single-sample workflow can be found in the [Kids First GitHub repository](https://github.com/kids-first/kf-jointgenotyping-workflow).
References can be obtained from the [Broad Genome References on AWS](https://s3.console.aws.amazon.com/s3/buckets/broad-references/hg38/v0/) bucket, with a general description of references here [@url:https://s3.amazonaws.com/broad-references/broad-references-readme.html].

### Somatic Mutation Calling

#### SNV and indel calling

For PBTA samples, we used four variant callers to call SNVs and indels from targeted DNA panel, WXS, and WGS data: Strelka2 [@doi:10.1038/s41592-018-0051-x], Mutect2 [@doi:10.1101/861054], Lancet  [@doi:10.1038/s42003-018-0023-9], and VarDict [@doi:10.1093/nar/gkw227].
WXS samples from TCGA were run using Strelka2, Mutect2 and Lancet.
TCGA samples were captured using different WXS target capture kits and all the BED files were downloaded from [`GDC portal`](https://api.gdc.cancer.gov/files).
The input interval BED files for both panel and WXS data for PBTA  samples were provided by the manufacturers.
For both PBTA and TCGA, all panel and WXS  BED files were padded by 100 bp on each side during Strelka2, Mutect2, and VarDict runs and 400 bp for the Lancet run.  
For WGS calling, we utilized the non-padded BROAD Institute interval calling list [`wgs_calling_regions.hg38.interval_list`](https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/wgs_calling_regions.hg38.interval_list), comprised of the full genome minus N bases, unless otherwise noted below.
Strelka2 [@doi:10/gdwrp4] v2.9.3 was run using default parameters for canonical chromosomes (chr1-22, X,Y,M), as recommended by the authors.
The final Strelka2 VCF was filtered for PASS variants.
Mutect2 from GATK v4.1.1.0 was run following Broad best practices outlined from their Workflow Description Language (WDL) [@url:https://github.com/broadinstitute/gatk/blob/4.1.1.0/scripts/mutect2_wdl/mutect2.wdl].
The final Mutect2 VCF was filtered for PASS variants.
To manage memory issues, VarDictJava [@doi:10.1093/nar/gkw227] v1.58 [@url:https://github.com/AstraZeneca-NGS/VarDictJava] was run using 20Kb interval chunks of the input BED, padded by 100 bp on each side, such that if an indel occurred in between intervals, it would be captured.
Parameters and filtering followed [BCBIO standards](https://github.com/bcbio/bcbio-nextgen) except that variants with a variant allele frequency (VAF) >= 0.05 (instead of >= 0.10) were retained.
The 0.05 VAF increased the true positive rate for indels and decreased the false positive rate for SNVs when using VarDict in consensus calling.
The final VCF was filtered for PASS variants with TYPE=StronglySomatic.
Lancet v1.0.7 was run using default parameters, except for those noted below.
For input intervals to Lancet WGS, a reference BED was created by using only the UTR, exome, and start/stop codon features of the GENCODE 31 reference, augmented as recommended with PASS variant calls from Strelka2 and Mutect2 [@doi:10.1101/623702].
These intervals were then padded by 300 bp on each side during Lancet variant calling.
Per recommendations by the New York Genome Center [@doi:10.1101/623702], for WGS samples, the Lancet input intervals described above were augmented with PASS variant calls from Strelka2 and Mutect2 as validation.

#### VCF annotation and MAF creation

Normalization of INDELs using `bcftools norm` [@url:http://samtools.github.io/bcftools/bcftools.html#norm] was performed on all PASS VCFs using the following subworkflow [@url:https://github.com/d3b-center/OpenPBTA-workflows/blob/master/cwl/kfdrc_annot_vcf_sub_wf.cwl], release v3.
The ENSEMBL Variant Effect Predictor [@doi:10/gdz75c], reference release 93, was used to annotate variants and bcftools was used to add population allele frequency (AF) from gnomAD.
SNV and INDEL hotspots from v2 of MSKCC's database [@url:https://www.cancerhotspots.org/#/download] plus the C228T and C250T TERT promoter mutations [@doi:10.3390/ijms21176034] were annotated.
SNVs were annotated by matching amino acid position (`Protein_position` column in MAF file) with SNVs in the MSKCC database, splice sites were matched to `HGVSp_Short`values in the MSKCC database, and INDELs were matched based on amino acid present within the range of INDEL hotspots values in the MSKCC database.
Non-hotspot annotated variants with a normal depth of <= 7 and/or gnomAD AF > 0.001 were removed as potential germline variants.
TERT promoter mutations were matched using hg38 coordinates from [@doi:10.3390/ijms21176034]: C228T occurs at 5:1295113, is annotated as existing variant `s1242535815`, `COSM1716563`, `COSM1716558`, and is 66bp away from TSS and C250T occurs at Chr5:1295135, is annotated as existing variant `COSM1716559`, and is 88 bp away from TSS.

The final set of variants were retained if annotated as PASS or HotSpotAllele=1. 
MAFs were created using MSKCC's vcf2maf [@url:https://github.com/mskcc/vcf2maf] v1.6.17.

#### Gather SNV and INDEL Hotspots
All variant calls from Strelka2, Mutect2, or Lancet that overlap with an SNV or INDEL hotspot from v2 of MSKCC's database [@url:https://www.cancerhotspots.org/#/download] or the C228T and C250T TERT promoter mutations [@doi:10.3390/ijms21176034] were retained in a hotspot-specific MAF file, which was used for select analyses as described in the methods below.
VarDict-only calls were not retained since ~ 39M calls with low VAF were uniquely called and may be potential false positives.

#### Consensus SNV Calling

Our SNV calling process led to separate sets of predicted mutations for each caller.
We considered mutations to describe the same change if they were identical for the following MAF fields: `Chromosome`, `Start_Position`, `Reference_Allele`,  `Allele`, and `Tumor_Sample_Barcode`.
Strelka2 does not call multinucleotide variants (MNV), but instead calls each component SNV as a separate mutation, so we separated MNV calls from Mutect2 and Lancet into consecutive SNVs before comparing them with Strelka2.
We examined the variant allele frequencies produced by each caller and compared their overlap with each other [@url:https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/master/analyses/snv-callers/compare_snv_callers_plots.Rmd].
VarDict calls included many variants that were not identified by other callers [@url:https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/master/analyses/snv-callers/plots/comparison/upset_plot.png], while the other callers produced results that were relatively consistent with one another.
Many of these VarDict-specific calls were variants with low allele frequency [@url:https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/master/analyses/snv-callers/plots/comparison/vaf_violin_plot.png].
We termed mutations shared among the other three callers (Strelka2, Mutect2, and Lancet) to be consensus mutation calls and dropped VarDict due to concerns about it calling a large number of false positives.
In practice, because our filtered set was based on the intersection of these three sets and because VarDict called nearly every mutation from the other three callers plus many that were unique to it, the decision to not consider VarDict calls has little impact on the results.

For some downstream analyses, only coding sequence SNVs (based on GENCODE v27 [@url:https://www.gencodegenes.org/human/release_27.html]) are used, to enhance comparability to other studies.
We considered base pairs to be *effectively surveyed* if they were in the intersection of the genomic ranges considered by the callers used to generate the consensus and where appropriate, regions of interest, such as coding sequences.
This definition of *effectively surveyed* base pairs is what is used to calculate effective genome size for calculations for tumor mutation burden and mutational signatures.

#### Recurrently mutated genes and co-occurrence of gene mutations

Using the consensus SNV calls, we identified genes that were recurrently mutated in the cohort, including nonsynonymous mutations with a variant allele frequency greater than 5% among the set of independent samples.
The set of nonsynonymous mutations was determined using ENSEMBL Variant Effect Predictor [@doi:10/gdz75c] annotations, including High and Moderate consequence types as defined in `maftools` [@doi:10.1101/gr.239244.118].
For each gene, we then tallied the number of samples that had at least one nonsynonymous mutation.

For genes that contained nonsynonymous mutations in multiple samples, we calculated pairwise mutation co-occurrence scores.
This score was defined as the $I\times -\log_{10}(P)$ where $I$ is 1 when the odds ratio is > 1 (indicating co-occurrence), and -1 when the odds ratio is < 1 (indicating mutual exclusivity), with $P$ defined by  Fisher's Exact Test.

### Somatic Copy Number Variant Calling (WGS samples only)

We used Control-FREEC [@doi:10/ckt4vz; @doi:10/c6bcps] v11.6 and CNVkit [@doi:10.1371/journal.pcbi.1004873] v0.9.3 for copy number variant calls.
For both algorithms, the `germline_sex_estimate` (described below) was used as input for sample sex and germline variant calls (above) were used as input for BAF estimation.
Control-FREEC was run on human genome reference hg38 using the optional parameters of a 0.05 coefficient of variation, ploidy choice of 2-4, and BAF adjustment for tumor-normal pairs.
Theta2 [@doi:10.1093/bioinformatics/btu651] used VarDict germline and somatic calls, filtered on PASS and strongly somatic, to infer tumor purity.
Theta2 purity was added as an optional parameter to CNVkit to adjust copy number calls.
CNVkit was run on human genome reference hg38 using the optional parameters of Theta2 purity and BAF adjustment for tumor-normal pairs.
We used GISTIC [@doi:10.1186/gb-2011-12-4-r41] v.2.0.23 on the CNVkit and the consensus CNV segmentation files to generate gene-level copy number abundance (Log R Ratio) as well as chromosomal arm copy number alterations using the parameters specified in the [OpenPBTA Analysis repository](https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/master/analyses/run-gistic/scripts/run-gistic-openpbta.sh).

#### Consensus CNV Calling

For each caller and sample, CNVs were called based on consensus among Control-FREEC [@doi:10/ckt4vz; @doi:10/c6bcps], CNVkit [@doi:10.1371/journal.pcbi.1004873], and Manta [@doi:10/gf3ggb].
CNVs called significant by Control-FREEC (p-value < 0.01) were included in the consensus calling.
Sample and caller combination files with more than 2500 CNVs called were removed from the set; we expect these to be noisy and poor quality samples based on cutoffs used in GISTIC [@doi:10.1186/gb-2011-12-4-r41]. 
After filtering CNVs called by Manta [@doi:10/gf3ggb] to only contain pass-filter regions, for each sample, the following regions are included in the final consensus set: 1) regions with reciprocal overlap of at least 50% between two of the three callers; 2) smaller CNV regions that are at least 90% covered by another caller. 
Any copy number alteration that was not called by two or more callers was not included in the consensus file. 
For the samples that are included in the consensus file, if a certain region has a neutral call, copy number of `NA` is defined for that region.
CNV regions within 10,000 bp of each other with the same direction of gain or loss were merged into single region.
We filtered out any CNVs that overlapped 50% or more with immunoglobulin, telomeric, centromeric, segment duplicated regions or were shorter than 3000 bp. 


#### Focal Copy Number Calling

We added the ploidy inferred via Control-FREEC to the consensus CNV segmentation file and used the ploidy and copy number values to define gain and loss values broadly at the chromosome level.
We used bedtools coverage [@url:https://bedtools.readthedocs.io/en/latest/content/tools/coverage.html; @doi:10.1093/bioinformatics/btq033] to add cytoband status using the UCSC cytoband file [@url:http://hgdownload.cse.ucsc.edu/goldenpath/hg38/database/cytoBand.txt.gz; @doi:10.1093/nar/gks1048].
The output status call fractions, which are values of the loss, gain and callable fractions of each cytoband region, were used to define dominant status at the cytoband-level.
The weighted means of each status call fraction were calculated using band length.
We used the weighted means to define the dominant status at the chromosome arm-level.

A status is considered dominant if more than half of the region was callable and the status call fraction was greater than 0.9 for that region.
The 0.9 threshold was chosen to ensure that the dominant status fraction call is greater than the remaining status fraction calls in a region.

We also wanted to define focal copy number units to avoid calling adjacent genes in the same cytoband or arm as copy number losses or gains where it would be more appropriate to call the broader region a loss or gain.
For the determination of the most focal units, we first considered the dominant status calls at the chromosome arm-level.
If the chromosome arm dominant status was not clearly defined as a gain or loss (and was callable) we looked to include the cytoband-level status call.
Similarly, if a cytoband dominant status call was not clearly defined as a gain or loss (and was callable) we looked to include the gene-level status call.
To obtain the gene-level data, we used the mergeByOverlaps function [@url:https://www.rdocumentation.org/packages/IRanges/versions/2.6.1/topics/findOverlaps-methods] from the IRanges package [@doi:10.1371/journal.pcbi.1003118] to find overlaps between the segments in the consensus CNV file and the exons in the GENCODE v27 annotation file [@url:https://www.gencodegenes.org/human/release_27.html].
If the copy number value was 0, we set the status to "deep deletion". 
For autosomes only, we set the status to "amplification" when the copy number value is greater than two times the ploidy value.

### Somatic Structural Variant Calling (WGS samples only)

We used Manta SV [@doi:10/gf3ggb] v1.4.0 for structural variant (SV) calls.
Manta SV calling was also limited to regions used in Strelka2.
The hg38 reference for SV calling used was limited to canonical chromosome regions.
The somatic DNA workflow for SNV, indel, copy number, and SV calling can be found in the [KidsFirst Github repository](https://github.com/kids-first/kf-somatic-workflow).
Manta SV output was annotated using [AnnotSV v2.1](https://lbgi.fr/AnnotSV/) [@doi:10.1093/bioinformatics/bty304] and the workflow can be found in the [D3b GitHub repository](https://github.com/d3b-center/annotSV/tree/master).

### Gene Expression

#### Abundance Estimation

We used STAR [@doi:10/f4h523] v2.6.1d to align paired-end RNA-seq reads.
This output was used for all subsequent RNA analysis.
We used Ensembl GENCODE 27 [@url:https://www.gencodegenes.org/human/release_27.html], "Comprehensive gene annotation" as a reference.
We used RSEM [@doi:10/cwg8n5] v1.3.1 for both FPKM and TPM transcript- and gene-level quantification.
We also added a second method of quantification using kallisto [@doi:10.1038/nbt.3519] v0.43.1.
This method differs in that it uses pseudoaligments using FASTQ reads directly to the aforementioned GENCODE 27 reference.

#### Gene Expression Matrices with Unique HUGO Symbols

Algorithms that perform gene set enrichment, molecular subtyping, or immune-profiling, for example, require an RNA-seq gene expression matrix as input, with HUGO gene symbols as row names and sample names as column names.
There is a small proportion of gene symbols that map to multiple Ensembl gene identifiers (in GENCODE v27, 212 gene symbols map to 1866 Ensembl gene identifiers), termed multi-mapped gene symbols.

We first removed genes with no expression from the RSEM abundance data using a cut-off of FPKM > 0 in at least 1 sample across the PBTA cohort.
We computed the mean FPKM across all samples per gene and for each multi-mapped gene symbol, we chose the Ensembl identifier corresponding to the maximum mean FPKM with the goal of choosing the identifier that best represented the expression of the gene.
After collapsing gene identifiers, there were a total of 46,400 unique expressed genes in the poly-A dataset and a total of 53,011 unique expressed genes remaining in the stranded dataset.
More detail can be found in the [`collapse-rnaseq` analysis module](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/collapse-rnaseq).

#### Immune Profiling/Deconvolution

We used the R package immunedeconv [@pmid:31510660; @url:https://github.com/icbi-lab/immunedeconv] to deconvolute, quantify and compare various immune cell types across 21 histologies from the PBTA cohort with xCell [@doi:10.1186/s13059-017-1349-1] and CIBERSORT [@doi:10.1038/nmeth.3337] in the stranded and poly-A collapsed FPKM RNA-seq datasets ([`immune-deconv` analysis module](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/immune-deconv)).
Both methods allow between samples (inter-sample), between cell types (intra-sample) and between cancer type (inter-histology) comparisons.

#### Gene Set Variation Analysis

We performed Gene Set Variation Analysis (GSVA) [@doi:10.1186/1471-2105-14-7] on collapsed, log2-transformed RSEM FPKM data using the GSVA Bioconductor package [@doi:10.18129/B9.bioc.GSVA] with setting `mx.diff=TRUE` to obtain Gaussian-distributed scores ([`gene-set-enrichment-analysis` analysis module](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/gene-set-enrichment-analysis)) for each of the MSigDB hallmark gene sets [@doi:10.1016/j.cels.2015.12.004].
We compared GSVA scores among histology groups (`short_histology`) using ANOVA and subsequent Tukey tests; p-values were Bonferroni-corrected for multiple hypothesis testing.

#### Dimension reduction

We applied Uniform Manifold Approximation and Projection (UMAP) [@arxiv:1802.03426v2] to log2-transformed FPKM data using the umap R package [@url:https://cran.r-project.org/package=umap].
We set the number of neighbors to 15 ([`transcriptomic-dimension-reduction` analysis module](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/transcriptomic-dimension-reduction)).

### RNA Fusion Calling and Prioritization

#### Gene fusion detection

We set up [Arriba v1.1.0](https://github.com/suhrig/arriba/) and STAR-Fusion 1.5.0 [@doi:10.1101/120295] fusion detection tools using CWL on CAVATICA.
For both these tools we used aligned BAM and chimeric SAM files from STAR as inputs and GRCh38_gencode_v27 GTF for gene annotation.
We ran STAR-Fusion with default parameters and annotated all fusion calls with GRCh38_v27_CTAT_lib_Feb092018.plug-n-play.tar.gz provided in the STAR-fusion release.
For Arriba, we used a blacklist file (blacklist_hg38_GRCh38_2018-11-04.tsv.gz) from the Arriba release tarballs to remove recurrent fusion artifacts and transcripts present in healthy tissue.
We also provided Arriba with strandedness information or set it to auto-detection for poly-A samples.
We used [FusionAnnotator](https://github.com/FusionAnnotator/FusionAnnotator) on Arriba fusion calls in order to harmonize annotations with those of STAR-Fusion.
The RNA expression and fusion workflows can be found in the [KidsFirst GitHub repository](https://github.com/kids-first/kf-rnaseq-workflow) and the FusionAnnotator workflow found in the [D3b GitHub repository](https://github.com/d3b-center/FusionAnnotator).

#### Fusion prioritization

We performed artifact filtering and additional annotation on fusion calls to prioritize putative oncogenic fusions.
Briefly, we considered all in frame and frameshift fusion calls with a minimum of 1 junction reads and at least one gene partner expressed (TPM > 1) to be true calls.
If a fusion call had large number of spanning fragment reads compared to junction reads (spanning fragment minus junction read greater than ten), we removed these calls as potential false positives.
We prioritized a union of fusion calls as true calls if the fused genes were detected by both callers, the same fusion was recurrent within a `broad_histology` (>2 samples) or the fusion was specific to the `broad_histology`.
If either 5' or 3' genes fused to more than five different genes within a sample, we removed these calls as potential false positives.
We annotated putative driver fusions and prioritized fusions based on partners containing known [kinases](http://kinase.com/human/kinome/tables/Kincat_Hsap.08.02.xls), [oncogenes](http://www.bushmanlab.org/assets/doc/allOnco_Feb2017.tsv), [tumor suppressors](https://bioinfo.uth.edu/TSGene/Human_TSGs.txt?csrt=5027697123997809089), curated transcription factors [@doi:10.1016/j.cell.2018.01.029], [COSMIC genes](https://cancer.sanger.ac.uk/census), and/or known [TCGA fusions](https://tumorfusions.org/PanCanFusV2/downloads/pancanfus.txt.gz) from curated [references](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/fusion_filtering/references).
_MYBL1_ [@doi:10.1073/pnas.1300252110], _SNCAIP_ [@doi:10.1038/nature11327], _FOXR2_ [@doi:10.1016/j.cell.2016.01.015], _TTYH1_ [@doi:10.1038/ng.2849], and _TERT_ [@doi:10.1038/ng.3438; @doi:10.1002/gcc.22110; @doi:10.1016/j.canlet.2014.11.057; @doi:10.1007/s11910-017-0722-5] were added to the oncogene list and _BCOR_ [@doi:10.1016/j.cell.2016.01.015] and _QKI_ [@doi:10.1038/ng.3500] were added to the tumor suppressor gene list based on pediatric cancer literature review.
The fusion filtering workflow can be found in the [OpenPBTA Analysis repository](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/fusion_filtering).

### Mutational Signatures

We obtained weights for signature sets by applying deconstructSigs [@doi:10.1186/s13059-016-0893-4 ; @url:https://github.com/raerose01/deconstructSigs] to consensus SNVs with the BSgenome.Hsapiens.UCSC.hg38 annotations [@url:https://bioconductor.org/packages/release/data/annotation/html/BSgenome.Hsapiens.UCSC.hg38.html].
We estimated how many mutations contributed to each signature for each sample using each sample's signature weights.
Weights for signatures fall in the range zero to one inclusive.
For a given sample and signature combination, we estimated the number of contributing mutations per Mb of the genome by multiplying the signature weight by the total number of trinucleotide mutations identified by deconstructSigs and then dividing by the size of the effectively surveyed genome.  

$$ \frac{\textrm{# of contributing mutations}}{Mb} = \frac{\textrm{weight} * \sum{\textrm{# Trinucleotide mutations}}} {\textrm{Size in Mb of effectively surveyed genome}}
$$

These results do not include signatures with small contributions; deconstructSigs drops signature weights that are less than 6% [@doi:10.1186/s13059-016-0893-4].
We used these methods to calculate signature scores for each sample with both COSMIC [@url:https://cancer.sanger.ac.uk/cosmic] and Alexandrov et al, 2013 [@doi:10.1038/nature12477] signature sets.

### PBTA Tumor Mutation Burden

We consider tumor mutation burden (TMB) to be the number of consensus SNVs per *effectively surveyed* base of the genome.

$$ \textrm{TMB} = \frac{\textrm{\# of coding sequence SNVs}}{\textrm{Size in Mb of {\em effectively surveyed} genome}}
$$

We used the total number coding sequence consensus SNVs for the numerator and the size of the intersection of the regions considered by Lancet, Strelka2, and Mutect2 with coding regions (CDS from GENCODE v27 annotation [@url:https://www.gencodegenes.org/human/release_27.html]) as the denominator.

### TCGA Tumor Mutation Burden

We calculated tumor mutation burden in TCGA using MC3 mutation calls [@doi:10.1016/j.cels.2018.03.002] for TCGA brain-related tumor projects including: LGG (lower-grade glioma) [@doi:10.1056/NEJMoa1402121], GBM (glioblastoma multiforme) [@doi:10.1016/j.cell.2013.09.034], and PCPG (pheochromocytoma and paraganglioma) [@doi:10.1016/j.ccell.2017.01.001].
The MC3 project provided an exome BED file.
All SNVs fell within these regions.
We considered the regions covered by the MC3 BED file (based on GENCODE v19 annotation [@url:https://www.gencodegenes.org/human/release_19.html]) to have been effectively surveyed.

### Clinical Data Harmonization

#### WHO Classification of Disease Types

For the CBTN cohort, the `pathology_diagnosis` field in the `pbta-histologies.tsv` file contains a harmonized diagnosis based on the patient's pathology report.
For the PNOC003 cohort, the `pathology_diagnosis` field in the `pbta-histologies.tsv` file contains the diagnosis gathered from the patient's pathology report.
For the CBTN cohort, the `pathology_free_text_diagnosis` field in the `pbta-histologies.tsv` file contains additional free text diagnosis information gathered from the patient's pathology report.
The `integrated_diagnosis` field in the `pbta-histologies.tsv` file is the standardized 2016 WHO diagnosis [@doi:10.1007/s00401-016-1545-1] based on `pathology_diagnosis`, molecular subtyping, and in some cases, additional pathology review.
The `broad_histology` denotes the broad 2016 WHO classification for each tumor.
The `short_histology` is an abbreviated version of either the `broad_histology` or `integrated_diagnosis` for plotting purposes.
The `CNS_region` was subtyped into hemispheric, midline, mixed, or other based on specimen location (see table below).


| ﻿Clinical and Histology Metadata | Definition | Possible values |
|---------------------------|----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| age_at_diagnosis_days | Patient age at diagnosis in days | numeric |
| age_last_update_days | Patient age at the last clinical event/update in days | numeric |
| aliquot_id | External aliquot identifier | variable |
| broad_composition | Broad classification of sample type | cell-line;cyst;non-tumor;tumor |
| broad_histology | Broad WHO 2016 classification of cancer type | text |
| cancer_predispositions | Reported cancer predisposition syndromes | text |
| cohort | Scientific cohort | CBTN;PNOC |
| cohort_participant_id | Scientific cohort participant ID | C#####-C###### |
| composition | Sample composition | Derived Cell Line;Not Reported;Peripheral Whole Blood;Saliva;Solid Tissue |
| ethnicity | Patient reported ethnicity | text |
| experimental_strategy | Sequencing strategy | WGS;WXS;RNA-Seq;Panel |
| germline_sex_estimate | Predicted sex of patient based on germline X and Y ratio calculation (described in methods) | Female;Male;Unknown |
| CNS_region | Brain region based on `primary_site` | |
| integrated_diagnosis | 2016 WHO diagnosis integrated from pathology diagnosis and molecular subtyping | text |
| Kids_First_Biospecimen_ID | KidsFirst biospecimen identifier | BS_######## |
| Kids_First_Participant_ID | KidsFirst patient identifier | PT_######## |
| molecular_subtype | Molecular subtype defined by WHO 2016 guidelines | text |
| normal_fraction | Theta2 normal DNA fraction estimate | numeric |
| Notes | Free text field describing changes from `pathology_diagnosis` to `integrated_diagnosis` or manner in which molecular_subtype was determined | text |
| OS_days | Overall survival in days | numeric |
| OS_status | Overall survival status | DECEASED;LIVING |
| parent_aliquot_id | External identifier combining sample_id, sample_type, aliquot_id, and sequencing_strategy for some samples | text |
| pathology_diagnosis | Reported and/or harmonized patient diagnosis from pathology reports | text |
| pathology_free_text_diagnosis | Free text patient diagnosis from pathology reports | text |
| primary_site | Bodily site(s) from which specimen was derived | text |
| race | Patient reported race | text |
| reported_gender | Patient reported gender | text |
| RNA_library | Type of RNA-Sequencing library preparation | stranded;poly-A |
| sample_id | External biospecimen identifier | variable |
| sample_type | Broad sample type | Normal;Tumor |
| seq_center | Sequencing center | BGI@CHOP Genome Center;Genomic Clinical Core at Sidra Medical and Research Center;NantOmics;TGEN |
| short_histology | Abbreviated `integrated_diagnosis` or `broad_histology` for plotting purposes | text |
| tumor_descriptor | Phase of therapy from which tumor was derived | Initial CNS Tumor;Progressive Progressive Disease Post-Mortem;Recurrence;Second Malignancy;Unavailable |
| tumor_fraction | Theta2 tumor DNA fraction estimate | numeric |
| tumor_ploidy | Control-FREEC ploidy | numeric  |


Table S1. Clinical metadata collected for OpenPBTA. {#tbl:S1}


| CNS_region      | primary_site                                                                                                                   |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------|
| Hemispheric     | Frontal Lobe,Temporal Lobe,Parietal Lobe,Occipital Lobe                                                                        |
| Midline         | Pons/Brainstem,Brain Stem- Midbrain/Tectum,Brain Stem- Pons,Brain Stem-Medulla,Thalamus,Basal Ganglia,Hippocampus,Pineal Gland |
| Spine           | Spinal Cord- Cervical,Spinal Cord- Thoracic,Spinal Cord- Lumbar/Thecal Sac,Spine NOS                                           |
| Ventricles      | Ventricles                                                                                                                     |
| Posterior fossa | Cerebellum/Posterior Fossa                                                                                                     |
| Optic pathway   | Optic Pathway                                                                                                                  |
| Suprasellar     | Suprasellar/Hypothalamic/Pituitary                                                                                             |
| Other           | Meninges/Dura,Other locations NOS,Skull,Cranial Nerves NOS,Brain                                                               |


Table S2. Harmonized CNS brain regions derived from primary site values. {#tbl:S2}


#### Molecular Subtyping

The `molecular_subtype` column in the `pbta-histologies.tsv` file contains molecular subtypes for tumor types selected from  `pathology_diagnosis` and `pathology_free_text_diagnosis` fields as described below, following World Health Organization 2016 classification criteria [@doi:10.1007/s00401-016-1545-1].

Medulloblastoma (MB) subtypes SHH, MYC, Group 3, and Group 4 were predicted using the consensus of two RNA expression classifiers: [Medulloblastoma Classifier]](https://github.com/d3b-center/medullo-classifier-package) and MM2S Classifier [@doi:10.1186/s13029-016-0053-y] on the RSEM FPKM data.

High-grade glioma (HGG) subtypes were derived using the criteria below (additional details in the [analysis README](https://github.com/AlexsLemonade/OpenPBTA-analysis/tree/master/analyses/molecular-subtyping-HGG)):

1. If any sample contained an H3F3A K28M, HIST1H3B K28M, HIST1H3C K28M, or HIST2H3C K28M mutation and no BRAF V600E mutation, it was subtyped as `DMG, H3K28`.
2. If any sample contained an HIST1H3B K28M, HIST1H3C K28M, or HIST2H3C K28M mutation and a BRAF V600E mutation, it was subtyped as `DMG, H3 K28, BRAF V600E`.
3. If any sample contained an H3F3A G35V or G35R mutation, it was subtyped as`HGG, H3 G35`.
4. If any high-grade glioma sample contained an IDH1 R132 mutation, it was subtyped as `HGG, IDH`.
5. If a sample was initially classified as HGAT, had no defining histone mutations, and a BRAF V600E mutation, it was subtyped as `BRAF V600E`.
6. All other high-grade glioma samples that did not meet any of these criteria were subtyped as `HGG, H3 wildtype`.

Non-MB and non-ATRT embryonal (`Embryonal tumor` in the `broad_histology` column of the metadata pbta-histologies.tsv) subtypes were derived using the criteria below [@pmid:30249036; @doi:10.1007/s00381-017-3551-6; @url:https://www.cancer.gov/types/brain/hp/child-cns-embryonal-treatment-pdq; @doi:10.3390/ijms21051818].
Additional details can be found in the analysis [notebook](https://alexslemonade.github.io/OpenPBTA-analysis/analyses/molecular-subtyping-embryonal/04-table-prep.nb.html).

1. Any RNA-seq biospecimen with <i>LIN28A</i> overexpression, plus a <i>TTYH1</i> fusion (5' partner) with a gene adjacent or within the C19MC miRNA cluster and/or copy number amplification of the C19MC region was subtyped as `ETMR, C19MC-altered` (Embryonal tumor with multilayer rosettes, chromosome 19 miRNA cluster altered).
2. Any RNA-seq biospecimen with <i>LIN28A</i> overexpression, a <i>TTYH1</i> fusion (5' partner) with a gene adjacent or within the C19MC miRNA cluster but no evidence of copy number amplification of the C19MC region was subtyped as `ETMR, NOS` (Embryonal tumor with multilayer rosettes, not otherwise specified).
3. Any RNA-seq biospecimen with a fusion having a 5' <i>MN1</i> and 3' <i>BEND2</i> or <i>CXXC5</i> partner were subtyped as `CNS HGNET-MN1` (Central nervous system (CNS) high-grade neuroepithelial tumor with _MN1_ alteration).
4. Non-MB and non-ATRT embryonal tumors with internal tandem duplication of _BCOR_ were subtyped as `CNS HGNET-BCOR` (CNS high-grade neuroepithelial tumor with _BCOR_ alteration).
5. Non-MB and non-ATRT embryonal tumors with over-expression and/or gene fusions in <i>FOXR2</i> were subtyped as `CNS NB-FOXR2` (CNS neuroblastoma with <i>FOXR2</i> activation).
6. Non-MB and non-ATRT embryonal tumors with <i>CIC-NUTM1</i> or other <i>CIC</i> fusions, were subtyped as `CNS EFT-CIC` (CNS Ewing sarcoma family tumor with <i>CIC</i> alteration).
7. Non-MB and non-ATRT embryonal tumors that did not fit any of the above categories were subtyped as CNS Embryonal, NOS (CNS Embryonal tumor, not otherwise specified).

In addition to tumor types mentioned above, TP53 altered status is also annotated for all samples and if a sample is analyzed to be either `TP53 loss` or `TP53 activated`, this annotation will be included in the `molecular_subtype` column. 
The analysis started by applying TCGA PanCan data trained TP53 inactivation classifier scores [@doi:10.1016/j.celrep.2018.03.076], which are weighted coefficients for each gene, to the matched RNA expression data for each sample. 
Along with the TP53 classifier scores, consensus SNV and CNV, SV, and references databases that list TP53 hotspot mutations [@url:https://www.cancerhotspots.org/#/home; @doi:10.1158/2159-8290.CD-17-0321; @doi:10.1038/nbt.3391] and functional domains [@doi:10.1038/sj.cdd.4401904] were used collectively to determine TP53 alternation status for each sample.
The rules for calling either `TP53 loss` or `TP53 activated` is as followed:
If a sample has any of the two well-characterized TP53 gain-of-function mutations, p.R273C or p.R248W [@doi:10.1038/ng0593-42], `TP53 activated` status will be assigned.
A sample will be annotated as `TP53 loss` if any of the following conditions is met:
1) It contains a TP53 hotspot mutation as defined by IARC TP53 database [@url:https://www.cancerhotspots.org/#/home; @doi:10.1158/2159-8290.CD-17-0321; @doi:10.1038/nbt.3391] 
2) It contains two TP53 alterations, including SNV, CNV or SV, which is indicative of probable bi-allelic alterations
3) It contains one TP53 somatic alteration, including SNV, CNV, or SV and a germline TP53 mutation indicated by the diagnosis of Li-Fraumeni syndrome [@pmid:28270529]
4) It contains one germline TP53 mutation indicated by Li-Faumeni syndrome and the TP53 classifier score for matched RNA-Seq is over 0.5. 

#### Survival

Overall survival, denoted `OS_days`, was calculated as days since initial diagnosis.

#### Prediction of participants' genetic sex

The clinical metadata provided included a reported gender.
We used DNA data, in concert with the reported gender, to predict participant genetic sex so that we could identify sexually dimorphic outcomes.
This analysis could also reveal samples that may have been contaminated in certain circumstances.
We used the idxstats utility from SAMtools [@pmid:19505943] to calculate read lengths, the number of mapped reads, and the corresponding chromosomal location for reads to the X and Y chromosomes.
We used the fraction of total normalized X and Y chromosome reads that were attributed to the Y chromosome as a summary statistic.
We reviewed this statistic in the context of reported gender and determined that a threshold of less than 0.2 clearly delineated female samples.
Fractions greater than 0.4 were predicted to be males.
Samples with values in the range [0.2, 0.4] were marked as unknown.
We ran this analysis through [CWL](https://github.com/d3b-center/sex-determination-tool) on Cavatica.
Resulting calls were added to the clinical metadata as `germline_sex_estimate`.

#### Selection of independent samples

Certain analyses required that we select only a single representative specimen for each individual.
In these cases, we prioritized primary tumors and those with whole-genome sequencing available.
If this filtering still resulted in multiple specimens, we selected from the remaining set randomly.

### Quantify Telomerase Activity using Gene Expression Data

We predicted telomerase activity of pediatric brain tumor samples using our recently developed method EXTEND. 
In brief, EXTEND estimates telomerase activity based on the expression of a 13-gene signature. 
This signature was derived by comparing telomerase positive tumors and tumors with activated alternative lengthening of telomeres pathway, a group presumably negative of telomerase activity. 
More details about the algorithm can be found in reference [@doi:https://doi.org/10.1101/2020.05.21.109249]. 
We calculated telomerase activity score for each sample of the PBTA cohort and examined the score distribution across both broad and specific disease histological subtypes. 
We also compared EXTEND scores across the four molecular subgroups of medulloblastoma (Group3, Group4, SHH and WNT) using a series of pairwise two-sample t-tests with a Bonferroni correction for multiple testing. 
EXTEND scores have been further compared, using Spearman rank correlation, between counts and FPKM gene expression values from poly-A and stranded protocols.
